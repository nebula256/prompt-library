<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù¾Ø±Ø§Ù…Ù¾Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Tahoma, sans-serif; }
        .hidden { display: none; }
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù‚Ø¯Ø§Ù… */
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.25rem; /* 20px */
            line-height: 1;
            padding: 0.25rem;
            margin: 0 0.125rem; /* Ú©Ù…ÛŒ ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        }
        .delete-btn {
            color: #ef4444; /* red-500 */
        }
        .delete-btn:hover {
            color: #b91c1c; /* red-700 */
        }
        .edit-btn {
            color: #3b82f6; /* blue-500 */
        }
        .edit-btn:hover {
            color: #1d4ed8; /* blue-700 */
        }
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ú©Ù¾ÛŒ */
        .copy-btn {
            position: absolute;
            top: 0.5rem; /* 8px */
            left: 0.5rem; /* 8px */
            padding: 0.25rem; /* 4px */
            background-color: white;
            border: 1px solid #e2e8f0; /* gray-200 */
            border-radius: 0.25rem; /* 4px */
            color: #6b7280; /* gray-500 */
            cursor: pointer;
            opacity: 0; /* Ù…Ø®ÙÛŒ Ø¨ÙˆØ¯Ù† Ø¨Ù‡ ØµÙˆØ±Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ */
            transition: opacity 0.2s;
            font-size: 0.8rem; /* Ú©ÙˆÚ†Ú©â€ŒØªØ± Ú©Ø±Ø¯Ù† Ø¢ÛŒÚ©ÙˆÙ†/Ù…ØªÙ† */
        }
        /* Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡ Ú©Ù¾ÛŒ Ù‡Ù†Ú¯Ø§Ù… Ù‡Ø§ÙˆØ± Ø±ÙˆÛŒ Ø±Ø¯ÛŒÙ */
        tr:hover .copy-btn {
            opacity: 1;
        }
        .copy-btn:hover {
            color: #3b82f6; /* blue-500 */
            background-color: #f9fafb; /* gray-50 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <!-- ... (Ú©Ø¯ HTML Ù‡Ø¯Ø± Ùˆ Ø¨Ø¯Ù†Ù‡ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯) ... -->
    
    <!-- Ù‡Ø¯Ø± ØµÙØ­Ù‡ -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <h1 class="text-3xl font-bold text-gray-800">ğŸš€ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù¾Ø±Ø§Ù…Ù¾Øª Ø´Ø±Ú©Øª</h1>
                <button id="addPromptButton" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-medium hover:bg-blue-700 transition duration-300">
                    + Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø±Ø§Ù…Ù¾Øª Ø¬Ø¯ÛŒØ¯
                </button>
            </div>
        </div>
    </header>

    <!-- Ø¨Ø®Ø´ Ø§ØµÙ„ÛŒ Ù…Ø­ØªÙˆØ§ -->
    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Ù†ÙˆØ§Ø± Ø§Ø¨Ø²Ø§Ø± (Ø¬Ø³ØªØ¬Ùˆ) -->
        <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
            <input type="text" id="searchInput" placeholder=" Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù¾Ø±Ø§Ù…Ù¾Øªâ€ŒÙ‡Ø§ (Ø¨Ø± Ø§Ø³Ø§Ø³ Ù‡Ø± Ø³ØªÙˆÙ†)..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <!-- Ø¨Ø®Ø´ Ø¬Ø¯ÙˆÙ„ Ù¾Ø±Ø§Ù…Ù¾Øªâ€ŒÙ‡Ø§ -->
        <div class="overflow-x-auto bg-white rounded-lg shadow">
            <!-- <--- ØªØºÛŒÛŒØ± Ø¯Ø± Ø§ÛŒÙ† Ø®Ø·: min-w-max Ø­Ø°Ù Ø´Ø¯ Ùˆ table-fixed Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ -->
            <table class="w-full text-sm text-right text-gray-700 border-collapse border border-gray-300">
                <!-- Ù‡Ø¯Ø± Ø¬Ø¯ÙˆÙ„ -->
                <thead class="bg-gray-800 text-white text-base">
                    <tr>
                        <th class="px-6 py-4 border border-gray-300">ğŸ’¡ Ù…ØªÙ† Ù¾Ø±Ø§Ù…Ù¾Øª</th>
                        <th class="px-6 py-4 border border-gray-300">ğŸ·ï¸ Ù…ÙˆØ¶ÙˆØ¹ / Ù…Ù†Ø§Ø³Ø¨Øª</th>
                        <th class="px-6 py-4 border border-gray-300">ğŸ”‘ Ú©Ù„Ù…Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ</th>
                        <th class="px-6 py-4 border border-gray-300">â›” Ù¾Ø±Ø§Ù…Ù¾Øª Ù…Ù†ÙÛŒ</th>
                        <!-- Ø³ØªÙˆÙ† Ù…ØªØºÛŒØ±Ù‡Ø§ Ø­Ø°Ù Ø´Ø¯ -->
                        <th class="px-6 py-4 border border-gray-300">ğŸ–¼ï¸ Ù†Ù…ÙˆÙ†Ù‡ Ø¨ØµØ±ÛŒ</th>
                        <th class="px-6 py-4 border border-gray-300">âœï¸ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§</th>
                        <th class="px-6 py-4 border border-gray-300">Ø§Ù‚Ø¯Ø§Ù…Ø§Øª</th>
                    </tr>
                </thead>
                <!-- Ø¨Ø¯Ù†Ù‡ Ø¬Ø¯ÙˆÙ„ Ú©Ù‡ Ù¾Ø±Ø§Ù…Ù¾Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ø¢Ù† Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù†Ø¯ -->
                <!-- Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø§Ú©Ù†ÙˆÙ† ØªÙˆØ³Ø· ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                <tbody id="promptTableBody">
                    <tr id="loadingRow">
                        <td colspan="7" class="px-6 py-10 text-center text-gray-500 text-lg border border-gray-300">
                             Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² ÙØ§ÛŒØ±Ø¨ÛŒØ³...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Ù…ÙˆØ¯Ø§Ù„ (Ù¾Ø§Ù¾â€ŒØ¢Ù¾) Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±Ø§Ù…Ù¾Øª -->
    <div id="addModal" class="hidden fixed inset-0 bg-black bg-opacity-60 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-3xl max-h-full overflow-y-auto">
            <div class="flex justify-between items-center border-b pb-3 mb-5">
                <h2 id="modalTitle" class="text-2xl font-semibold">Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø±Ø§Ù…Ù¾Øª Ø¬Ø¯ÛŒØ¯</h2>
                <button id="closeModalButton" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>
            
            <form id="addPromptForm" class="space-y-4">
                <!-- ... (Ú©Ø¯ HTML ÙØ±Ù… Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯) ... -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="promptText" class="block text-sm font-medium text-gray-700 mb-1">ğŸ’¡ Ù…ØªÙ† Ù¾Ø±Ø§Ù…Ù¾Øª <span class="text-red-500">*</span></label>
                        <textarea id="promptText" name="promptText" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                    </div>
                    <div>
                        <label for="promptNotes" class="block text-sm font-medium text-gray-700 mb-1">âœï¸ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§</label>
                        <textarea id="promptNotes" name="promptNotes" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="promptOccasion" class="block text-sm font-medium text-gray-700 mb-1">ğŸ·ï¸ Ù…ÙˆØ¶ÙˆØ¹ / Ù…Ù†Ø§Ø³Ø¨Øª</label>
                        <input type="text" id="promptOccasion" name="promptOccasion" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="promptKeywords" class="block text-sm font-medium text-gray-700 mb-1">ğŸ”‘ Ú©Ù„Ù…Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ</label>
                        <input type="text" id="promptKeywords" name="promptKeywords" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="promptNegative" class="block text-sm font-medium text-gray-700 mb-1">â›” Ù¾Ø±Ø§Ù…Ù¾Øª Ù…Ù†ÙÛŒ</label>
                        <input type="text" id="promptNegative" name="promptNegative" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <!-- Ø¨Ø®Ø´ Ù…ØªØºÛŒØ±Ù‡Ø§ Ø­Ø°Ù Ø´Ø¯ Ùˆ Ù„ÛŒÙ†Ú© ØªÙ…Ø§Ù…â€ŒØµÙØ­Ù‡ Ø´Ø¯ -->
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="promptLink" class="block text-sm font-medium text-gray-700 mb-1">ğŸ–¼ï¸ Ù„ÛŒÙ†Ú© Ù†Ù…ÙˆÙ†Ù‡ Ø¨ØµØ±ÛŒ</label>
                        <input type="url" id="promptLink" name="promptLink" placeholder="https://example.com" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ltr text-left">
                    </div>
                </div>
                <div class="flex justify-end pt-4 space-x-2 space-x-reverse">
                    <button type="button" id="cancelButton" class="bg-gray-200 text-gray-800 px-5 py-2 rounded-lg font-medium hover:bg-gray-300 transition duration-300">
                        Ø§Ù†ØµØ±Ø§Ù
                    </button>
                    <button type="submit" id="saveButton" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-medium hover:bg-blue-700 transition duration-300">
                        Ø°Ø®ÛŒØ±Ù‡
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ§ÛŒØ±Ø¨ÛŒØ³ -->
    <script type="module">
        // Import a specific version for compatibility
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            deleteDoc, 
            updateDoc, // <--- Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† updateDoc
            collection, 
            onSnapshot,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ ÙØ§ÛŒØ±Ø¨ÛŒØ³ ---
        
        // !!!!!!! ØªÙˆØ¬Ù‡ Ø¨Ø³ÛŒØ§Ø± Ù…Ù‡Ù… !!!!!!!
        // Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ø¢Ø¨Ø¬Ú©Øª `firebaseConfig` Ø±Ø§ Ú©Ù‡ Ø§Ø² Ú©Ù†Ø³ÙˆÙ„ ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ú©Ù¾ÛŒ Ú©Ø±Ø¯ÛŒØ¯ØŒ
        // Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯.
         const firebaseConfig = {
    apiKey: "AIzaSyCw3CvUnumkNgK2-uhZ1paUPetfBc-hOYs",
    authDomain: "my-prompt-library-35534.firebaseapp.com",
    projectId: "my-prompt-library-35534",
    storageBucket: "my-prompt-library-35534.firebasestorage.app",
    messagingSenderId: "374041398410",
    appId: "1:374041398410:web:8e0552f30229d8107cf173"
  };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯ Ú©Ø±Ø¯Ù†
        setLogLevel('Debug');

        // Ù…Ø³ÛŒØ± Ú©Ø§Ù„Ú©Ø´Ù† Ø¯Ø± ÙØ§ÛŒØ±Ø¨ÛŒØ³ (ÛŒÚ© Ù…Ø³ÛŒØ± Ø³Ø§Ø¯Ù‡)
        const promptsCollectionPath = "prompts"; // <-- Ø§Ø² ÛŒÚ© Ú©Ø§Ù„Ú©Ø´Ù† Ø³Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        const promptsCollection = collection(db, promptsCollectionPath);

        let userId = null;
        let currentEditId = null; // <--- Ù…ØªØºÛŒØ± Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´
        let allPrompts = []; // <--- Ø­Ø§ÙØ¸Ù‡ Ù…Ø­Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¬Ù‡Øª ÙˆÛŒØ±Ø§ÛŒØ´

        // --- 2. Ù…Ø¯ÛŒØ±ÛŒØª UI (Ø¹Ù†Ø§ØµØ± DOM) ---
        const addPromptButton = document.getElementById('addPromptButton');
        const modal = document.getElementById('addModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const cancelButton = document.getElementById('cancelButton');
        const addPromptForm = document.getElementById('addPromptForm');
        const tableBody = document.getElementById('promptTableBody');
        const searchInput = document.getElementById('searchInput');
        const modalTitle = document.getElementById('modalTitle');
        const saveButton = document.getElementById('saveButton');

        // --- ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ Ù…ØªÙ† ---
        async function copyToClipboard(text, btn) {
            try {
                await navigator.clipboard.writeText(text);
                btn.textContent = 'Ú©Ù¾ÛŒ Ø´Ø¯!';
                setTimeout(() => { btn.textContent = 'ğŸ“‹'; }, 1500);
            } catch (err) {
                console.error('Failed to copy: ', err);
                btn.textContent = 'Ø®Ø·Ø§!';
                setTimeout(() => { btn.textContent = 'ğŸ“‹'; }, 1500);
            }
        }

        // ØªØ§Ø¨Ø¹ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„
        const showModal = () => modal.classList.remove('hidden');
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø³ØªÙ† Ùˆ Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„
        const hideModal = () => {
            modal.classList.add('hidden');
            addPromptForm.reset();
            currentEditId = null;
            modalTitle.textContent = "Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø±Ø§Ù…Ù¾Øª Ø¬Ø¯ÛŒØ¯";
            saveButton.textContent = "Ø°Ø®ÛŒØ±Ù‡";
        };

        // Ø§ÛŒÙˆÙ†Øª Ù„ÛŒØ³Ù†Ø±Ù‡Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„
        addPromptButton.addEventListener('click', () => {
            // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø±ÛŒØ³Øª Ø¨ÙˆØ¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª "Ø§ÙØ²ÙˆØ¯Ù†"
            hideModal(); // Ø§ÙˆÙ„ Ø±ÛŒØ³Øª Ú©Ù†
            currentEditId = null; // ØµØ±Ø§Ø­ØªØ§Ù‹ Ø­Ø§Ù„Øª Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†
            modalTitle.textContent = "Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø±Ø§Ù…Ù¾Øª Ø¬Ø¯ÛŒØ¯";
            saveButton.textContent = "Ø°Ø®ÛŒØ±Ù‡";
            showModal(); // Ø­Ø§Ù„Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
        });
        closeModalButton.addEventListener('click', hideModal);
        cancelButton.addEventListener('click', hideModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) hideModal();
        });

        // --- 3. ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù† Ø±Ø¯ÛŒÙ Ø¬Ø¯ÙˆÙ„ ---
        function renderPromptRow(docSnapshot) { // Ù†Ø§Ù… Ù¾Ø§Ø±Ø§Ù…ØªØ± Ø§Ø² doc Ø¨Ù‡ docSnapshot ØªØºÛŒÛŒØ± Ú©Ø±Ø¯
            const data = docSnapshot.data(); // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯
            const row = tableBody.insertRow(-1); // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ Ø¬Ø¯ÙˆÙ„
            row.id = docSnapshot.id; // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯
            row.className = 'hover:bg-gray-50 transition duration-150';

            // Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ ÛŒÚ©ÛŒ Ø¯Ø± Ù…ÛŒØ§Ù† (Ø­Ø°Ù Ø´Ø¯ Ú†ÙˆÙ† Ø®Ø·ÙˆØ· Ú©Ø§Ù…Ù„ Ø¯Ø§Ø±ÛŒÙ…)
            // if (tableBody.rows.length % 2 === 0) { ... }
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-normal break-words border border-gray-300 relative">
                    <span class="prompt-text">${escapeHTML(data.text)}</span>
                    <button class="copy-btn" title="Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù…ØªÙ† Ù¾Ø±Ø§Ù…Ù¾Øª">ğŸ“‹</button>
                </td>
                <td class="px-6 py-4 whitespace-normal break-words border border-gray-300">${escapeHTML(data.occasion)}</td>
                <td class="px-6 py-4 whitespace-normal break-words border border-gray-300">${escapeHTML(data.keywords)}</td>
                <td class="px-6 py-4 whitespace-normal break-words border border-gray-300">${escapeHTML(data.negative)}</td>
                <td class="px-6 py-4 border border-gray-300">${data.link ? `<a href="${escapeHTML(data.link)}" class="text-blue-600 hover:underline" target="_blank">[Ù„ÛŒÙ†Ú© Ù†Ù…ÙˆÙ†Ù‡]</a>` : ''}</td>
                <td class="px-6 py-4 whitespace-normal break-words border border-gray-300">${escapeHTML(data.notes)}</td>
                <td class="px-6 py-4 text-center whitespace-nowrap border border-gray-300">
                    <button class="action-btn edit-btn" data-id="${docSnapshot.id}" title="ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±Ø§Ù…Ù¾Øª">âœï¸</button>
                    <button class="action-btn delete-btn" data-id="${docSnapshot.id}" title="Ø­Ø°Ù Ù¾Ø±Ø§Ù…Ù¾Øª">ğŸ—‘ï¸</button>
                </td>
            `;

            // Ø§ÙØ²ÙˆØ¯Ù† Ø§ÛŒÙˆÙ†Øª Ù„ÛŒØ³Ù†Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù
            row.querySelector('.delete-btn').addEventListener('click', async (e) => {
                const id = e.currentTarget.dataset.id; // e.target Ø¨Ù‡ e.currentTarget ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯
                
                // ÛŒÚ© ØªØ§ÛŒÛŒØ¯ Ø³Ø§Ø¯Ù‡ Ù‚Ø¨Ù„ Ø§Ø² Ø­Ø°Ù
                if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù¾Ø±Ø§Ù…Ù¾Øª Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                    try {
                        await deleteDoc(doc(db, promptsCollectionPath, id)); // Ø­Ø§Ù„Ø§ doc Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø¨Ù‡ ØªØ§Ø¨Ø¹ ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ø§Ø´Ø§Ø±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
                    } catch (error) {
                        console.error("Error deleting document: ", error);
                    }
                }
            });

            // --- Ø§ÙØ²ÙˆØ¯Ù† Ø§ÛŒÙˆÙ†Øª Ù„ÛŒØ³Ù†Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´ ---
            row.querySelector('.edit-btn').addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                const promptToEdit = allPrompts.find(p => p.id === id);

                if (promptToEdit) {
                    // ØªÙ†Ø¸ÛŒÙ… Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´
                    currentEditId = id;
                    modalTitle.textContent = "ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±Ø§Ù…Ù¾Øª";
                    saveButton.textContent = "Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª";

                    // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù… Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯
                    document.getElementById('promptText').value = promptToEdit.data.text || '';
                    document.getElementById('promptOccasion').value = promptToEdit.data.occasion || '';
                    document.getElementById('promptKeywords').value = promptToEdit.data.keywords || '';
                    document.getElementById('promptNegative').value = promptToEdit.data.negative || '';
                    // ÙÛŒÙ„Ø¯ Ù…ØªØºÛŒØ±Ù‡Ø§ Ø­Ø°Ù Ø´Ø¯
                    document.getElementById('promptLink').value = promptToEdit.data.link || '';
                    document.getElementById('promptNotes').value = promptToEdit.data.notes || '';

                    showModal();
                }
            });

            // --- Ø§ÙØ²ÙˆØ¯Ù† Ø§ÛŒÙˆÙ†Øª Ù„ÛŒØ³Ù†Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ú©Ù¾ÛŒ ---
            row.querySelector('.copy-btn').addEventListener('click', (e) => {
                const btn = e.currentTarget;
                const textToCopy = btn.closest('td').querySelector('.prompt-text').textContent;
                copyToClipboard(textToCopy, btn);
            });
        }

        // --- 4. Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±Ù… (Ø§ÙØ²ÙˆØ¯Ù† Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡) ---
        addPromptForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                text: document.getElementById('promptText').value,
                occasion: document.getElementById('promptOccasion').value,
                keywords: document.getElementById('promptKeywords').value,
                negative: document.getElementById('promptNegative').value,
                // ÙÛŒÙ„Ø¯ Ù…ØªØºÛŒØ±Ù‡Ø§ Ø­Ø°Ù Ø´Ø¯
                link: document.getElementById('promptLink').value,
                notes: document.getElementById('promptNotes').value,
                ownerId: userId // Ø°Ø®ÛŒØ±Ù‡ Ø¢ÛŒØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±
            };

            try {
                if (currentEditId) {
                    // --- Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´ ---
                    const docRef = doc(db, promptsCollectionPath, currentEditId);
                    await updateDoc(docRef, {
                        ...formData,
                        updatedAt: new Date() // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ® Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                    });
                } else {
                    // --- Ø­Ø§Ù„Øª Ø§ÙØ²ÙˆØ¯Ù† ---
                    await addDoc(promptsCollection, {
                        ...formData,
                        createdAt: new Date() // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯
                    });
                }
                
                // Ø±Ø¯ÛŒÙ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ØªÙˆØ³Ø· onSnapshot Ø¨Ù‡â€ŒØ±ÙˆØ² Ù…ÛŒâ€ŒØ´ÙˆØ¯
                hideModal();
                
            } catch (error) {
                console.error("Error saving document: ", error);
            }
        });

        // --- 5. Ù…Ø¯ÛŒØ±ÛŒØª Ø¬Ø³ØªØ¬Ùˆ (ÙÛŒÙ„ØªØ±) ---
        const filterTable = () => {
            const query = searchInput.value.toLowerCase();
            const rows = tableBody.getElementsByTagName('tr');

            for (const row of rows) {
                if (row.id === 'loadingRow' || row.id === 'emptyRow') continue; 
                
                const rowText = row.textContent.toLowerCase();
                if (rowText.includes(query)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        };
        searchInput.addEventListener('input', filterTable);

        // --- 6. ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ (Escape) ---
        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, function(m) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
            });
        }

        // --- 7. ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ (Ø§ØªØµØ§Ù„ Ùˆ Ø®ÙˆØ§Ù†Ø¯Ù† Ø¯Ø§Ø¯Ù‡) ---
        async function main() {
            try {
                // Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ ØµÙˆØ±Øª Ù†Ø§Ø´Ù†Ø§Ø³
                await signInAnonymously(auth);
                
                userId = auth.currentUser?.uid;
                console.log("User authenticated with ID:", userId);

                // Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³ (Real-time)
                onSnapshot(promptsCollection, (querySnapshot) => {
                    tableBody.innerHTML = ''; 
                    
                    if (querySnapshot.empty) {
                        tableBody.innerHTML = `<tr id="emptyRow"><td colspan="7" class="px-6 py-10 text-center text-gray-500 text-lg border border-gray-300">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ù¾Ø±Ø§Ù…Ù¾ØªÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø§ÙˆÙ„ÛŒÙ† Ù†ÙØ± Ø¨Ø§Ø´ÛŒØ¯!</td></tr>`;
                        allPrompts = []; // Ø®Ø§Ù„ÛŒ Ú©Ø±Ø¯Ù† Ø­Ø§ÙØ¸Ù‡ Ù…Ø­Ù„ÛŒ
                        return;
                    }

                    // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯ (Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø§ÙˆÙ„)
                    // (ØªÙˆØ¬Ù‡: createdAt Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¯Ø± Ø§Ø³Ù†Ø§Ø¯ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ø§ÛŒØ¯ Ù…Ù†Ø·Ù‚ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø±Ø§ Ø¨Ù‡ØªØ± Ú©Ù†ÛŒÙ…)
                    const docs = querySnapshot.docs
                        .map(doc => ({ id: doc.id, data: doc.data() })) // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ù…Ø­Ù„ÛŒ
                        .sort((a, b) => {
                            const timeA = a.data.createdAt?.toMillis() || 0;
                            const timeB = b.data.createdAt?.toMillis() || 0;
                            return timeB - timeA; // Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø§ÙˆÙ„
                        });
                    
                    allPrompts = docs; // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø­Ø§ÙØ¸Ù‡ Ù…Ø­Ù„ÛŒ

                    docs.forEach(docSnapshot => {
                        // Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ ÛŒÚ© Ø¢Ø¨Ø¬Ú©Øª Ø´Ø¨ÛŒÙ‡ Ø¨Ù‡ docSnapshot Ø¨Ø±Ø§ÛŒ ØªØ§Ø¨Ø¹ Ø±Ù†Ø¯Ø±
                        renderPromptRow({
                            id: docSnapshot.id,
                            data: () => docSnapshot.data
                        });
                    });
                    
                    filterTable();
                }, (error) => {
                    console.error("Error listening to collection: ", error);
                    tableBody.innerHTML = `<tr id="errorRow"><td colspan="7" class="px-6 py-10 text-center text-red-500 text-lg border border-gray-300">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§. Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.</td></tr>`;
                });

            } catch (error) {
            } catch (error) {
                console.error("Error during auth or initialization: ", error);
                tableBody.innerHTML = `<tr id="authErrorRow"><td colspan="7" class="px-6 py-10 text-center text-red-500 text-lg border border-gray-300">Ø®Ø·Ø§ Ø¯Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª. ${error.message}</td></tr>`;
            }
        }

        // --- 8. Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ ---
        document.addEventListener('DOMContentLoaded', main);

    </script>

</body>
</html>
